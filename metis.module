<?php

/**
 * @file
 * The metis module
 *
 * Allows you to add the VG Wort mtis pixel to nodes
 */

/**
 * Implements hook_perm().
 */
function metis_perm() {

  return array(
    'administer metis module',
    'add metis codes to nodes',
    'add site-wide metis codes',
    'add individual metis codes',
  );

}


/**
 * Implements hook_menu().
 */
function metis_menu() {

  $items = array();

  $items['admin/settings/metis'] = array(
    'title' => 'Metis',
    'description' => 'Metis settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('metis_settings_form'),
    'access arguments' => array('administer metis module'),
    'type' => MENU_LOCAL_TASK,
  );

  // Set default for tabs.
  $items['admin/settings/metis/settings'] = array(
    'title' => 'Metis settings',
    'access arguments' => array('administer metis module'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  );

  $items['admin/settings/metis/add'] = array(
    'title' => 'Paste Metis codes',
    'description' => 'Add metis codes by pasting them to a form',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('metis_codes_form'),
    'access arguments' => array('add site-wide metis codes'),
    'type' => MENU_LOCAL_TASK,
    'weight' => -5,
  );

  $items['admin/settings/metis/import_csv'] = array(
    'title' => 'Import Metis codes from CSV',
    'description' => 'Import <abbr title="Comma Separated Values">CSV</abbr> file with metis codes',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('metis_codes_csv_form'),
    'access arguments' => array('add site-wide metis codes'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 0,
  );

  $items['user/%/metis/add'] = array(
    'title' => 'Import Metis codes from CSV',
    'description' => 'Import <abbr title="Comma Separated Values">CSV</abbr> file with metis codes',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('metis_codes_user_csv_form'),
    'access arguments' => array('add individual metis codes'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 0,
  );

  if (module_exists('views')) {

    // Get metis field name(s).
    $fields = content_fields();
    $metis_fields = array();

    // Select metis fields.
    foreach ($fields as $field) {
      if ($field['type'] == 'metis') {
        $metis_fields[$field['field_name']]['field_name'] = $field['field_name'];
        $metis_fields[$field['field_name']]['field_label'] = $field['widget']['label'];
      }
    }

    // Create a menu entry for every metis field.
    foreach ($metis_fields as $field) {
      $items['admin/settings/metis/list_' . $field['field_name']] = array(
        'title' => 'List codes (field: ' . $field['field_label'] . ')',
        'description' => 'List used metis codes for field ' . $field['field_label'],
        'page callback' => 'views_page',
        'page arguments' => array('metis_' . $field['field_name']),
        'access arguments' => array('administer metis module'),
        'type' => MENU_LOCAL_TASK,
      );
    }
  }

  return $items;
}


/**
 * Implements hook_help().
 */
function metis_help($path, $arg) {

  switch ($path) {

    // Main module help.
    case 'admin/settings/metis':
      return '<p>' . t('The Metis module allows you to automatically insert the metis pixel provided by <a href="http://www.vgwort.de/">VG Wort</a>. To use the module you need to add a CCK Metis field to your content types.') . '</p>';

    case 'admin/help#metis':
      // Return a line-break version of the module README.txt.
      return filter_filter('process', 1, NULL, file_get_contents(dirname(__FILE__) . "/README.txt"));
  }
}


/**
 * Define the settings form.
 */
function metis_settings_form() {

  // Define a select list.
  $form['metis_default_server'] = array(
    '#type' => 'select',
    '#title' => t('Default Metis server'),
    '#description' => t('Please select the default Metis server to be used when uploading codes.'),
    '#default_value' => variable_get('metis_default_server', NULL),
    '#options'  => array(
      NULL => t('Please select'),
      'vg01.met.vgwort.de' => 'vg01.met.vgwort.de',
      'vg02.met.vgwort.de' => 'vg02.met.vgwort.de',
      'vg03.met.vgwort.de' => 'vg03.met.vgwort.de',
      'vg04.met.vgwort.de' => 'vg04.met.vgwort.de',
      'vg05.met.vgwort.de' => 'vg05.met.vgwort.de',
      'vg06.met.vgwort.de' => 'vg06.met.vgwort.de',
      'vg07.met.vgwort.de' => 'vg07.met.vgwort.de',
      'vg08.met.vgwort.de' => 'vg08.met.vgwort.de',
      'vg09.met.vgwort.de' => 'vg09.met.vgwort.de',
    ),
    '#required' => FALSE,
  );

  $form['status'] = array(
    '#type' => 'markup',
    '#value' => '<p>' . t('<strong>Status:</strong> There are currently %count_codes unused codes left.', array('%count_codes' => metis_count_unused())) . '</p>',
    '#weight' => -3,
  );

  return system_settings_form($form);

}


/**
 * Define the form for entering a code.
 */
function metis_codes_form() {

  // Define a textarea.
  $form['code'] = array(
    '#type' => 'textarea',
    '#title' => t('Metis code'),
    '#description' => t('Please enter Metis codes you want to save in the format [public_code];[private_code]. <strong>One per line. Every code and every ident must be 32 letters long.</strong>'),
    '#cols' => 32,
    '#rows' => 20,
    '#required' => TRUE,
  );

  // Define a select list.
  $form['server'] = array(
    '#type' => 'select',
    '#title' => t('Server'),
    '#description' => t('Please select a Metis server to be associated with the imported codes.'),
    '#default_value' => variable_get('metis_default_server', NULL),
    '#options'  => array(
      NULL => t('Please select'),
      'vg01.met.vgwort.de' => 'vg01.met.vgwort.de',
      'vg02.met.vgwort.de' => 'vg02.met.vgwort.de',
      'vg03.met.vgwort.de' => 'vg03.met.vgwort.de',
      'vg04.met.vgwort.de' => 'vg04.met.vgwort.de',
      'vg05.met.vgwort.de' => 'vg05.met.vgwort.de',
      'vg06.met.vgwort.de' => 'vg06.met.vgwort.de',
      'vg07.met.vgwort.de' => 'vg07.met.vgwort.de',
      'vg08.met.vgwort.de' => 'vg08.met.vgwort.de',
      'vg09.met.vgwort.de' => 'vg09.met.vgwort.de',
    ),
    '#required' => TRUE,
  );

  // Define a submit function.
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
  );

  return $form;

}


/**
 * Validate the input.
 */
function metis_codes_form_validate($form, &$form_state) {

  // Get rid of white spaces.
  $input = trim($form_state['values']['code']);

  // Split by line.
  $rows = explode("\n", $input);

  // Remove any extra \r characters left behind.
  $rows = array_filter($rows, 'trim');

  $codes = array();

  foreach ($rows as $row) {

    $items = explode(';', $row);

    // Prepare array for validation.
    $codes[] = array(
      'public' => check_plain(trim($items[0])),
      'private' => check_plain(trim($items[1])),
      'server' => $form_state['values']['server'],
    );

  }

  // Add validated codes to $form_state.
  $form_state['values']['validated'] = metis_code_validation($codes);

}


/**
 * Handle submission of metis codes.
 */
function metis_codes_form_submit($form, $form_state) {

  metis_code_submission($form_state['values']['validated']);

}


/**
 * Define the form for CSV import.
 */
function metis_codes_csv_form() {

  // Define a textarea.
  $form['file_csv'] = array(
    '#type' => 'file',
    '#title' => t('CSV file with Metis codes'),
    '#description' => t('Please upload the <abbr title="Comma Separated Values">CSV</abbr> file with metis codes.'),
  );

  // Define a select list.
  $form['server'] = array(
    '#type' => 'select',
    '#title' => t('Server'),
    '#description' => t('Please select a Metis server to be associated with the imported codes.'),
    '#default_value' => variable_get('metis_default_server', NULL),
    '#options'  => array(
      NULL => t('Please select'),
      'vg01.met.vgwort.de' => 'vg01.met.vgwort.de',
      'vg02.met.vgwort.de' => 'vg02.met.vgwort.de',
      'vg03.met.vgwort.de' => 'vg03.met.vgwort.de',
      'vg04.met.vgwort.de' => 'vg04.met.vgwort.de',
      'vg05.met.vgwort.de' => 'vg05.met.vgwort.de',
      'vg06.met.vgwort.de' => 'vg06.met.vgwort.de',
      'vg07.met.vgwort.de' => 'vg07.met.vgwort.de',
      'vg08.met.vgwort.de' => 'vg08.met.vgwort.de',
      'vg09.met.vgwort.de' => 'vg09.met.vgwort.de',
    ),
    '#required' => TRUE,
  );

  // Define a submit function.
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Import'),
  );

  // Set the form encoding type.
  $form['#attributes']['enctype'] = "multipart/form-data";

  return $form;

}


/**
 * Validate the input.
 */
function metis_codes_csv_form_validate($form, &$form_state) {
  // Attempt to save the uploaded file.
  $file = file_save_upload('file_csv');

  // Check file uploaded OK.
  if (!$file) {
    form_set_error('file_csv', t('A file must be uploaded.'));
  }
  elseif ($file->filemime != 'text/csv') {
    form_set_error('file_csv', t('The file must be of <abbr title="Comma Separated Values">CSV</abbr> type only.'));
  }
  else {
    // Parse CSV file.
    ini_set('auto_detect_line_endings', TRUE);
    $handle = @fopen($file->filepath, "r");

    while ($row = fgetcsv($handle, 0, ';')) {

      $codes[] = array(
        'public' => check_plain(trim($row[0])),
        'private' => check_plain(trim($row[1])),
        'server' => $form_state['values']['server'],
      );

    }

    // Add validated codes to $form_state.
    $form_state['values']['validated'] = metis_code_validation($codes);

  }
}


/**
 * Handle submission of metis codes from CSV.
 */
function metis_codes_csv_form_submit($form, &$form_state) {

  metis_code_submission($form_state['values']['validated']);

}


/**
 * Define the form for CSV import of individual codes.
 */
function metis_codes_user_csv_form() {

  // Define a textarea.
  $form['file_csv'] = array(
    '#type' => 'file',
    '#title' => t('CSV file with Metis codes'),
    '#description' => t('Please upload the <abbr title="Comma Separated Values">CSV</abbr> file with metis codes.'),
  );

  // Define a submit function.
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Import'),
  );

  // Set the form encoding type.
  $form['#attributes']['enctype'] = "multipart/form-data";

  return $form;

}


/**
 * Validate the input.
 */
function metis_codes_user_csv_form_validate($form, &$form_state) {
  // Attempt to save the uploaded file.
  $file = file_save_upload('file_csv');

  // Check file uploaded OK.
  if (!$file) {
    form_set_error('file_csv', t('A file must be uploaded.'));
  }
  elseif ($file->filemime != 'text/csv') {
    form_set_error('file_csv', t('The file must be of <abbr title="Comma Separated Values">CSV</abbr> type only.'));
  }
  else {
    // Parse CSV file.
    ini_set('auto_detect_line_endings', TRUE);
    $handle = @fopen($file->filepath, "r");

    $i = 0;

    while ($row = fgetcsv($handle, 0, ';')) {

      // Lines whose second element starts with '<img' contain the public code.
      if (substr($row[1], 0, 4) == '<img') {

        // Get the public code.
        preg_match('#http://vg[0-9]{2}\.met\.vgwort\.de/na/[0-9a-f]{32}#', $row[1], $url);
        $codes[$i]['public'] = check_plain(substr($url[0], -32, 32));

        // Get the server.
        preg_match('#vg[0-9]{2}\.met\.vgwort\.de#', $row[1], $server);
        $codes[$i]['server'] = check_plain($server[0]);
      }

      // Lines whose second element starts with 'Privater
      // Identifikationscode:' contain the private code.
      if ($row[1] == 'Privater Identifikationscode:') {
        $codes[$i]['private'] = check_plain($row[2]);
        $i++;
      }

    }

    // Add validated codes to $form_state.
    $form_state['values']['validated'] = metis_code_validation($codes);

  }
}


/**
 * Handle submission of metis codes from CSV.
 */
function metis_codes_user_csv_form_submit($form, &$form_state) {

  global $user;
  metis_code_submission($form_state['values']['validated'], $user->uid);

}


/**
 * Validate submitted codes.
 *
 * @param array $codes
 *   An array of arrays containing the code values. Valid arguments are:
 *     - 'public' => string containing the 32 letter public code;
 *     - 'private' => string containing the 32 letter private code;
 *
 * @param array $type
 *   An array containing the type of validation. Valid arguments are:
 *     - 'editorial' => upload of the editorial code format.
 *     - 'anonymous' => upload of the anonymous code format.
 *     - 'author' => upload of the auhtor code format.
 *
 * @return
 *   An array with the validated codes split up into arrays:
 *     - 'ignored' => codes to ignore.
 *     - 'public_length' => codes whose public code isn't 32 characters long.
 *     - 'private_length' => codes whose private code isn't 32 characters long.
 *     - 'code_exists' => codes that already exists in db.
 *     - 'valid' => codes that are valid.
 *     - 'error_validaton' => the $codes variable that led to an error.
 */
function metis_code_validation($codes) {

  $codes_validated = array();

  if (is_array($codes)) {

    $pattern = array(
      'Öffentlicher',
      'Identifikationscode',
      'Privater',
      'VG Wort',
    );

    foreach ($codes as $code) {

      // Variable used to determine if code should be ignored.
      $ignore = FALSE;

      foreach ($pattern as $needle) {
        if (stripos($code['public'], $needle) || stripos($code['private'], $needle)) {
          $codes_validated['ignored'][] = $code;
          $ignore = TRUE;
          break;
        }
      }

      if (!$ignore) {

        // Check if code is already in db.
        $query = "SELECT code_public
                  FROM {metis}
                  WHERE code_public = '%s'";

        $row = db_query($query, $code['public']);

        // Error if code is already in db.
        if (db_affected_rows($row) != 0) {
          $codes_validated['code_exists'][] = $code;
        }
        // Error if public code too long.
        elseif (drupal_strlen($code['public']) != 32) {
          $codes_validated['public_length'][] = $code;
        }
        // Error if private code too long.
        elseif ($code['private'] && drupal_strlen($code['private']) != 32) {
          $codes_validated['private_length'][] = $code;
        }
        // Error if server doesn't match.
        elseif (preg_match('#vg[0-9]{2}\.met\.vgwort\.de#', $code['server']) == 0) {
          $codes_validated['server'][] = $code;
        }
        // Valid code.
        else {
          $codes_validated['valid'][] = $code;
        }

      }

    }

  }
  else {
    $codes_validated['error_validaton'][] = $codes;
  }

  return $codes_validated;

}


/**
 * Submit codes.
 *
 * @param array $codes_validated
 *   An array of arrays containing the validated codes, valid arguments are:
 *     - 'public' => string containing the 32 letter public code;
 *     - 'private' => string containing the 32 letter private code;
 *
 * @param int $user
 *   The user ID for the code. 0 stands for site-wide.
 *
 * @return
 *   Status messages.
 */
function metis_code_submission($codes_validated, $user = 0) {

  $count_submit = 0;
  $count_error_submit = 0;

  // Submit valid codes.
  if ($codes_validated['valid']) {
    foreach ($codes_validated['valid'] as $code) {
          $submit = db_query("INSERT INTO {metis} (code_public, code_private, user, server) VALUES ('%s', '%s', '%s', '%s')", $code['public'], $code['private'], $user, $code['server']);
      if ($submit) {
        $count_submit++;
      }
      else {
        $count_error_submit++;
      }
    }
  }

  // Status count.
  $count_ignored = count($codes_validated['ignored']);
  $count_public_length = count($codes_validated['public_length']);
  $count_private_length = count($codes_validated['private_length']);
  $count_server = count($codes_validated['server']);
  $count_code_exists = count($codes_validated['code_exists']);
  $count_error_validation = count($codes_validated['error_validaton']);

  // Set confirmation message.
  if ($count_submit > 0) {
    drupal_set_message(t('%count codes have been saved.', array('%count' => $count_submit)));
  }
  if ($count_ignored > 0) {
    drupal_set_message(t('%count lines have been ignored.', array('%count' => $count_ignored)), 'warning');
  }
  if ($count_public_length > 0) {
    drupal_set_message(t('%count codes have not been saved because the public code is not 32 letters long.', array('%count' => $count_public_length)), 'warning');
  }
  if ($count_private_length > 0) {
    drupal_set_message(t('%count codes have not been saved because the private code is not 32 letters long.', array('%count' => $count_private_length)), 'warning');
  }
  if ($count_server > 0) {
    drupal_set_message(t('%count codes have not been saved because the server wasn\'t valid.', array('%count' => $count_server)), 'warning');
  }
  if ($count_code_exists > 0) {
    drupal_set_message(t('%count codes have not been saved because they already existed.', array('%count' => $count_code_exists)), 'warning');
  }
  if ($count_error_validation > 0) {
    drupal_set_message(t('There have been %count validation errors.', array('%count' => $count_error_validation)), 'error');
  }
  if ($count_error_submit > 0) {
    drupal_set_message(t('%count codes have not been saved because of an error.', array('%count' => $count_error_submit)), 'error');
  }

}


/**
 * Count unused codes.
 */
function metis_count_unused() {

  // Select an unused code from db.
  $query = "SELECT code_public
            FROM {metis}
            WHERE used = 0";

  return db_affected_rows(db_query($query));

}


/**
 * Get unused code.
 */
function metis_get_unused() {

  // Select an unused code from db.
  $query = "SELECT code_public, code_private, server
            FROM {metis}
            WHERE used = 0";

  $row = db_query($query);

  // If there are no unused codes, return FALSE.
  if (db_affected_rows($row) == 0) {

    return FALSE;

  }
  // If there are unused codes, return an array
  // with public and private code.
  else {
    $data = db_fetch_object($row);
    return array(
      'code_public' => $data->code_public,
      'code_private' => $data->code_private,
      'server' => $data->server,
    );
  }
}


/**
 * Set code used.
 */
function metis_set_used($code_public, $nid) {

  // Check if code has 32 characters and nid is present.
  if (drupal_strlen($code_public) == 32 && is_numeric($nid)) {

    // Check if code is already set as used.
    $query = "SELECT used
              FROM {metis}
              WHERE code_public = '%s'
              AND used > 0";

    $row = db_query($query, $code_public);

    // If code is not set as used, set it.
    if (db_affected_rows($row) == 0) {

      // Update database and set used codes as used.
      $query = "UPDATE {metis}
                SET used = '%s'
                WHERE code_public = '%s'
                AND used = 0";

      db_query($query, $nid, $code_public);

      // Set watchdog message if db has been updated.
      if (db_affected_rows() > 0) {
        watchdog('metis', 'Code %public_code has been set as "used" by node %nid.', array('%public_code' => $code_public, '%nid' => $nid));
      }

      return TRUE;

    }

    return FALSE;

  }
  else {

    return FALSE;

  }

}

/**
 * Implements hook_views_api().
 */
function metis_views_api() {
  return array(
    'api' => 2.0,
  );
}


/**
 * Define a CCK field
 */

/**
 * Implements hook_field_info().
 */
function metis_field_info() {
  return array(
    'metis' => array(
      'label' => t('Metis'),
      'description' => t('VG Wort metis code'),
    ),
  );
}


/**
 * Implements hook_field_access().
 */
function metis_field_access($op, $field, $account = NULL, $node = NULL) {

  switch ($op) {

    case 'edit':
      return user_access('add metis codes to nodes', $account);
      break;

  }

  return TRUE;

}


/**
 * Implements hook_field_settings().
 */
function metis_field_settings($op, $field) {
  switch ($op) {

    // Define the database storage for the field.
    case 'database columns':
      $columns['code_public'] = array(
        'type' => 'varchar',
        'length' => 32,
        'not null' => FALSE,
        'sortable' => TRUE,
        'views' => TRUE,
      );
      $columns['code_private'] = array(
        'type' => 'varchar',
        'length' => 32,
        'not null' => FALSE,
        'sortable' => TRUE,
        'views' => TRUE,
      );
      $columns['show'] = array(
        'type' => 'int',
        'length' => 1,
        'not null' => FALSE,
        'sortable' => TRUE,
        'views' => TRUE,
      );
      $columns['server'] = array(
        'type' => 'varchar',
        'length' => 256,
        'not null' => FALSE,
        'sortable' => TRUE,
        'views' => TRUE,
      );

      return $columns;

    case 'views data':
      // Prepare field for views.
      $data = content_views_field_views_data($field);
      $db_info = content_database_info($field);
      $table_alias = content_views_tablename($field);
      $field_data = $data[$table_alias][$field['field_name'] . '_value'];

      return $data;
  }
}


/**
 * Implements hook_field().
 */
function metis_field($op, &$node, $field, &$items, $teaser, $page) {
  switch ($op) {

    case 'presave':
      // Get an unused code.
      $unused = metis_get_unused();

      // Check if a public code is set already.
      // If not and the "show" option is selected, add a new one.
      if ($unused && empty($items[0]['code_public']) && $items[0]['show'] == 1) {

        if (is_array($unused)) {
          $items[0]['code_public'] = $unused['code_public'];
          $items[0]['code_private'] = $unused['code_private'];
          $items[0]['server'] = $unused['server'];
        }

      }

      break;

    case 'insert':
      // Set code as used after node is saved.
      if ($items[0]['code_public']) {
        metis_set_used($items[0]['code_public'], $node->nid);
      }
      break;
  }
}

/**
 * Implements hook_content_is_empty().
 */
function metis_content_is_empty($item, $field) {

  if (empty($item['code_public'])) {
    return TRUE;
  }

  return FALSE;

}

/**
 * Define a widget
 */

/**
 * Implements hook_widget_info().
 */
function metis_widget_info() {

  return array(

    // The machine name of the widget, no more than 32 characters.
    'code_widget' => array(

      // The human-readable label of the field that will be
      // seen in the Manage fields screen.
      'label' => t('Metis widget'),

      // An array of the field types this widget can be used with.
      'field types' => array('metis'),

      // Who will handle multiple values, default is core.
      // 'CONTENT_HANDLE_MODULE' means the module does it.
      'multiple values' => CONTENT_HANDLE_CORE,

      'callbacks' => array(

        // Who will create the default value, default is core.
        'default value' => CONTENT_CALLBACK_DEFAULT,

      ),
    ),
  );
}


/**
 * Implements hook_elements().
 */
function metis_elements() {

  $elements = array(
    'code_widget' => array(
      '#input' => TRUE,
      '#process' => array('metis_code_widget_process'),
    ),
  );

  return $elements;
}


/**
 * Implements hook_process().
 */
function metis_code_widget_process($element, $edit, &$form_state, $form) {

  $defaults = $element['#value'];
  $field = content_fields($element['#field_name'], $element['#type_name']);

  $element['code_public'] = array(
    '#title' => t('Public code'),
    '#type' => 'hidden',
    '#default_value' => $defaults['code_public'],
    '#weight' => 0,
  );

  $element['code_private'] = array(
    '#title' => t('Private code'),
    '#type' => 'hidden',
    '#default_value' => $defaults['code_private'],
    '#weight' => 1,
  );

  $element['server'] = array(
    '#title' => t('Metis server'),
    '#type' => 'hidden',
    '#default_value' => $defaults['server'],
    '#weight' => 2,
  );

  $element['show'] = array(
    '#title' => t('Include public code in article (enable count)'),
    '#type' => 'checkbox',
    '#default_value' => $defaults['show'],
    '#weight' => 3,
  );

  // Disable select field if there are no unused codes left.
  if (!$defaults['code_public'] && !$defaults['show'] && metis_count_unused() == 0) {

    $element['show']['#disabled'] = 'disabled';
    $element['show']['#description'] = '<span style="color:red">' . t('There are no unused codes left! Field has been disabled, please add new codes.') . '</span>';

  }
  elseif ($defaults['code_public'] && $defaults['code_private']) {

    $element['show']['#description'] = t('Public code: %code_public<br /> Private code: %code_private<br /> Server: %server', array('%code_public' => $defaults['code_public'], '%code_private' => $defaults['code_private'], '%server' => $defaults['server']));

  }

  return $element;
}


/**
 * Implements hook_widget().
 */
function metis_widget(&$form, &$form_state, $field, $items, $delta = 0) {

  $element = array(
    '#type' => $field['widget']['type'],
    '#default_value' => isset($items[$delta]) ? $items[$delta] : '',
    // Needs to be added to display title with single value.
    // http://poplarware.com/articles/cck_field_module#comment-3344.
    '#field' => $field,

  );

  return $element;

}


/**
 * Implements hook_theme().
 */
function theme_code_widget($element) {

  $output = $element['#children'];

  // Needs to be added to display title with single value.
  // http://poplarware.com/articles/cck_field_module#comment-3344.
  if (empty($element['#field']['multiple'])) {

    $output = '<label for="edit-field-metis-0-code-public-wrapper">' . $element['#field']['widget']['label'] . '</label>' . $output;
    $output .= $element['#field']['widget']['description'];

  }

  return $output;

}


/**
 * Define formatters.
 */

/**
 * Implements hook_field_formatter_info().
 *
 * All fields should have a 'default' formatter.
 * Any number of other formatters can be defined as well.
 * It's nice for there always to be a 'plain' option
 * for the raw value, but that is not required.
 */
function metis_field_formatter_info() {

  return array(

    // The machine name of the formatter.
    'default' => array(

      // The human-readable label shown on the Display.
      // fields screen.
      'label' => t('Metis pixel as <img>'),

      // An array of the field types this formatter
      // can be used on.
      'field types' => array('metis'),

      'multiple values' => CONTENT_HANDLE_CORE,
    ),

    'codes' => array(
      'label' => t('Metis codes'),
      'field types' => array('metis'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),

    'code_public' => array(
      'label' => t('Public metis code'),
      'field types' => array('metis'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),

    'code_private' => array(
      'label' => t('Private metis code'),
      'field types' => array('metis'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),

    'show' => array(
      'label' => t('Show metis pixel (yes/no)'),
      'field types' => array('metis'),
      'multiple values' => CONTENT_HANDLE_CORE,
    ),
  );
}


/**
 * Implements hook_theme().
 */
function metis_theme() {
  return array(
    // Themes for the formatters.
    'code_widget' => array(
      'arguments' => array('element' => NULL),
    ),
    'metis_formatter_default' => array(
      'arguments' => array('element' => NULL),
    ),
    'metis_formatter_codes' => array(
      'arguments' => array('element' => NULL),
    ),
    'metis_formatter_code_public' => array(
      'arguments' => array('element' => NULL),
    ),
    'metis_formatter_code_private' => array(
      'arguments' => array('element' => NULL),
    ),
    'metis_formatter_show' => array(
      'arguments' => array('element' => NULL),
    ),
  );
}


/**
 * Theme function for default field formatter.
 *
 * $element['#item']: the sanitized $delta value for the item,
 * $element['#field_name']: the field name,
 * $element['#type_name']: the $node->type,
 * $element['#formatter']: the $formatter_name,
 * $element'#node']: the $node,
 * $element['#delta']: the delta of this item, like '0',
 */
function theme_metis_formatter_default($element = NULL) {

  if (empty($element['#item'])) {
    return '';
  }

  if ($element['#item']['show'] && !empty($element['#item']['code_public']) && !empty($element['#item']['server'])) {

    return '<img class="metis_code_img" src="http://' . $element['#item']['server'] . '/na/' . $element['#item']['code_public'] . '" height="1" width="1" alt="" />';

    // TODO: Hide in teaser.
    // TODO: Hide label.
  }

}


/**
 * Theme function for field formatter that shows the codes.
 */
function theme_metis_formatter_codes($element = NULL) {

  if (empty($element['#item'])) {
    return '';
  }

  return '<p><strong>Public code:</strong> ' . $element['#item']['code_public'] . '<br /><strong>Private code:</strong> ' . $element['#item']['code_private'] . '</p>';

}


/**
 * Theme function for field formatter that shows the public code.
 */
function theme_metis_formatter_code_public($element = NULL) {

  if (empty($element['#item'])) {
    return '';
  }

  return $element['#item']['code_public'];

}


/**
 * Theme function for field formatter that shows the private code.
 */
function theme_metis_formatter_code_private($element = NULL) {

  if (empty($element['#item'])) {
    return '';
  }

  return $element['#item']['code_private'];

}


/**
 * Theme function for field formatter show.
 *
 * Shows wether the code is set to be shown.
 */
function theme_metis_formatter_show($element = NULL) {

  if (empty($element['#item'])) {
    return '';
  }

  switch ($element['#item']['show']) {

    case '0':
      return t('no');
      break;

    case '1':
      return t('yes');
      break;

  }

}
